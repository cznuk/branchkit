const fs = require("fs");
const path = require("path");
const { VersionSync } = require("./watch");
const { getTargetIdFromPath } = require("./cli-helpers");

class UISwitcherScaffold {
  constructor(filePath, shouldWatch = true) {
    this.shouldWatch = shouldWatch;
    this.originalFilePath = path.resolve(filePath);

    if (!fs.existsSync(this.originalFilePath)) {
      console.error(`File does not exist: ${this.originalFilePath}`);
      process.exit(1);
    }

    const parsedPath = path.parse(this.originalFilePath);
    this.componentName = parsedPath.name;
    this.parentDir = parsedPath.dir;
    this.originalExtension = parsedPath.ext; // Preserve .tsx or .ts
    this.v1File = path.join(this.parentDir, `${this.componentName}.v1${this.originalExtension}`);
    this.versionsFile = path.join(this.parentDir, `${this.componentName}.versions.ts`);
    this.targetId = getTargetIdFromPath(this.originalFilePath, process.cwd());

    console.log(`Scaffolding forked component from: ${this.originalFilePath}`);
    console.log(`Component name: ${this.componentName}`);
    console.log(`Target directory: ${this.parentDir}`);
    console.log(`Target id: ${this.targetId}`);
  }

  moveOriginalToV1() {
    // Move the original file to ComponentName.v1.tsx in the same directory
    fs.renameSync(this.originalFilePath, this.v1File);
    console.log(`Moved: ${path.basename(this.originalFilePath)} -> ${path.basename(this.v1File)}`);
  }

  createVersionsFile() {
    // Remove extension from import path (e.g., Button.v1.tsx -> ./Button.v1)
    const v1ImportPath = `./${this.componentName}.v1`;
    const versionsContent = `/**
 * THIS FILE IS GENERATED by branchkit.
 * Manual edits to labels/descriptions are preserved, but structure changes may be overwritten.
 * To stop versioning this component, run: npx branchkit promote ${this.componentName} <version-id>
 */
import ${this.componentName}V1 from "${v1ImportPath}"

export const VERSIONS = {
  "v1": {
    render: ${this.componentName}V1,
    label: "",
  },
}
`;

    fs.writeFileSync(this.versionsFile, versionsContent);
    console.log(`Created: ${path.basename(this.versionsFile)}`);
  }

  createWrapper() {
    // Import ForkedComponent from branchkit package
    const versionsImportPath = `./${this.componentName}.versions`;
    const wrapperContent = `"use client"

/**
 * THIS FILE IS GENERATED by branchkit.
 * Do not edit this file directly. Edit the version files instead (e.g., ${this.componentName}.v1${this.originalExtension}).
 * To stop versioning this component, run: npx branchkit promote ${this.componentName} <version-id>
 */
import { ForkedComponent } from "branchkit"
import { VERSIONS } from "${versionsImportPath}"

export default function ${this.componentName}(props: any) {
  return (
    <ForkedComponent
      id="${this.targetId}"
      versions={VERSIONS}
      props={props}
    />
  )
}

export { VERSIONS }
`;

    const wrapperFile = path.join(this.parentDir, `${this.componentName}${this.originalExtension}`);
    fs.writeFileSync(wrapperFile, wrapperContent);
    console.log(`Created wrapper: ${path.basename(wrapperFile)}`);
  }

  scaffold() {
    this.moveOriginalToV1();
    this.createVersionsFile();
    this.createWrapper();

    console.log("\nâœ… Scaffolding complete!");
    console.log("\nFor now, each version file must default-export its component.");
    console.log("   Named exports are something we're considering for the future.");
    console.log("\nNext steps:");
    console.log(
      `1. Your original component is now ${this.componentName}.v1${this.originalExtension}`,
    );
    console.log(`2. BranchKit will auto-initialize if you've set it up in your HTML.`);
    console.log(`   For Vite, add to your index.html <head>:`);
    console.log(`
   <script type="module">
     if (import.meta.env.DEV) {
       import("branchkit/auto-init");
     }
   </script>
`);
    console.log(`   Or manually add <BranchKit /> to your app root (only in development):`);
    console.log(`
   import { BranchKit } from "branchkit"
   import "branchkit/style.css"
   
   function App() {
     return (
       <>
         <YourApp />
         {process.env.NODE_ENV === "development" && <BranchKit />}
       </>
     )
   }
`);
    if (this.shouldWatch) {
      console.log("3. Starting watch mode...");
      console.log(
        `4. Add new versions by creating ${this.componentName}.v2${this.originalExtension}, ${this.componentName}.v1_1${this.originalExtension}, etc.`,
      );
      console.log(
        `5. Import the component: import ${this.componentName} from './${this.componentName}'`,
      );
      // Start watching automatically
      new VersionSync(this.parentDir);
    } else {
      console.log(`3. Run: npx branchkit watch (to start the watch server)`);
      console.log(
        `4. Add new versions by creating ${this.componentName}.v2${this.originalExtension}, ${this.componentName}.v1_1${this.originalExtension}, etc.`,
      );
      console.log(
        `5. Import the component: import ${this.componentName} from './${this.componentName}'`,
      );
    }
  }
}

module.exports = { UISwitcherScaffold };
